---
title: "Taller de Consultoría - Módulo 1"
output: html_document
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r load-packages, include=FALSE}
library(tidyr)
library(scales)
library(lubridate)
library(ggthemes)
library(ggplot2)
library(dplyr)
library(caret)
library(lubridate)

## Reading the data
ratings <- read.csv("ml-latest-small/ratings.csv")
movies <- read.csv("ml-latest-small/movies.csv")
tags <- read.csv("ml-latest-small/tags.csv")


# joining all the data
movielens <- left_join(ratings, movies, by = "movieId")
```
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

## Modelo 1

Se tiene una base de datos con información de películas (título, año, genero ...) y
también de valoraciones de los usuarios (puntuación y etiquetas asignadas).

## Algunas exploraciones

```{r}
tibble(`Initial Date` = date(as_datetime(min(movielens$timestamp), origin="1970-01-01")),
       `Final Date` = date(as_datetime(max(movielens$timestamp), origin="1970-01-01"))) %>%
  mutate(Period = duration(max(movielens$timestamp)-min(movielens$timestamp)))
```

Número de valoraciones por año


```{r}
# number of ratings per year
movielens %>% mutate(year = year(as_datetime(timestamp, origin="1970-01-01"))) %>%
  ggplot(aes(x=year)) +
  geom_histogram(color = "white") + 
  ggtitle("Número de valoraciones por año") +
  xlab("Año") +
  ylab("Número de Valoraciones") +
  scale_y_continuous(labels = comma) + 
  theme_fivethirtyeight()
``` 

**Frecuencia de cada una de las Valoraciones**

```{r}
movielens %>% group_by(rating) %>% summarize(n=n())
```


```{r}
movielens %>% group_by(rating) %>% 
  summarise(count=n()) %>%
  ggplot(aes(x=rating, y=count)) + 
  geom_line() +
  geom_point() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  ggtitle("Distribución de valoraciones", subtitle = "Valoraciones altas son predominantes.") + 
  xlab("Rating") +
  ylab("Count") +
  theme_fivethirtyeight()

```
**Cantidad de Valoraciones por película**


```{r}
movielens %>% group_by(movieId) %>%
  summarise(n=n()) %>%
  ggplot(aes(n)) +
  geom_histogram(color = "white") +
  scale_x_log10() + 
  ggtitle("Cantidad de valoraciones por película", 
          subtitle = "Mayoría de películas tiene menos de 1000 valoraciones.") +
  xlab("Número de valoraciones") +
  ylab("Número de películas") + 
  theme_fivethirtyeight()
```

**Valoraciones por usuario**

```{r}
 movielens  %>% group_by(userId) %>%
  summarise(n=n()) %>%
  ggplot(aes(n)) +
  geom_histogram(color = "white") +
  scale_x_log10() + 
  ggtitle("Cantidad de valoraciones por usuario", 
          subtitle="Distribución con sesgo a la derecha.") +
  xlab("Cantidad de valoraciones") +
  ylab("Cantidad de usuarios") + 
  scale_y_continuous(labels = comma) + 
  theme_fivethirtyeight()
```

**Sparseness en la asociación de usuarios y películas valoradas**

```{r}
users <- sample(unique(movielens$userId), 100)
movielens %>% filter(userId %in% users) %>%
  select(userId, movieId, rating) %>%
  spread(movieId, rating) %>% 
  select(sample(ncol(.), 100)) %>% 
  as.matrix() %>% t(.) %>%
  image(1:100, 1:100,. , xlab="Películas", ylab="Usuarios")
abline(h=0:100+0.5, v=0:100+0.5, col = "grey")
title("Matriz de Usuarios vs Películas")
```
## El problema de la Recomendación
